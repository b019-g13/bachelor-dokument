\clearpage
\section{Back-end dokumentasjon}
\subsection{Installasjon}
Startet med å laste ned laravel, xampp og Gitkraken til datamaskinen. Gjorde clone til repositoren som ble opprettet tidligere i github. Repositoren inneholder laravel. 

\subsection{Database}
Opprettet en database til prosjektet på phpMyAdmin og satt inn databasen og innloggingsinformasjonen i konfigurasjonsfilen .env. Så laget det modeller for databasen. Modellene lages ved å skrive koden nede i kommandolinjen. 
\begin{lstlisting}
    Php artisan make:model Modelnavn -m
\end{lstlisting}  
Det siste “-m” brukes for å opprette migrasjon for modellen  samtidig. Dette dropes og opprettes etter på: 
 \begin{lstlisting}   
    Php artisan make:migration tabellnavn.
\end{lstlisting}
Etter modellene og migrasjonene er på plass kan det lages felter på tabellene og ta migrasjon for å legge til tabellene til phpMyAdmin. Legge til migrasjonene til phpMyAdmin ved å sette koden Php artisan migrate  i kommandolinjen.
AppServiceProvider defualtlength satt til varchar(255). Dette gjøres for å bestemme lengden på strengen.
Oppretting av  attributter på tabellene gjøres slik: 

\begin{lstlisting}
    $table->type('atributtnavn');
\end{lstlisting}

Brukte UUID som primære nøkler på de fleste  tabellene.  UUID (Universally unique identifier) er en ID som kan gis til tabellrader for å identifisere dem på en måte som er litt finere enn et sekvensielt tabell-ID.\footnote{\url{https://medium.com/binary-cabin/automatically-generating-a-uuid-on-your-laravel-models-b8b9c3599e2b}} Dette hjelper å har større tabellrader enn å bruke increments.

\subsection{Feil under migrasjon}
Prøvde å ta migrasjon oppsto en feilmelding.
\begin{lstlisting}
Illuminate\Database\QueryException : SQLSTATE[42000]: Syntax error or access violation: 1071 Specified key was too long; max key length is 767 bytes (SQL: alter table `users` add unique `users_email_unique`(`email`))
\end{lstlisting}
Årsaken var at datamaskinen har gammel versjon av mysql som ikke støtter standard streng lengde på 255. Da måtte streng lengden endre til 191 og løste feilen.

\subsection{Lage forhold mellom modellene}
Opprettet relasjoner mellom database-modellene. 
Relasjoner  lages ved å bruke  manyToMany,(belongsToMany), One to One(hasOne), Many to One(belongsTo) og  One to Many (hasMany). Eks.  slik  

\begin{lstlisting}
    $this->hasMany(‘App\Model’) og invers.
\end{lstlisting}

\subsection{Lagringstest til DB}
Etter jeg opprettet ferdig koblingene mellom modellene, tok jeg test for å lagre data på databasen.Testen gjorde på alle tabellene.

\subsection{Feilmeldinger}
\subsubsection{Felt har ikke  standardverdi}
Fremmednøkkel feltet har ikke  standardverdi.

\begin{lstlisting}
    SQLSTATE[HY000]: General error: 1364 Field 'id' doesn't have a default value (SQL: insert into `fields` (`name`, `slug`, `updated_at`, `created_at`) values (HELLO WORLD, hello_world, 2019-02-06 08:57:48, 2019-02-06 08:57:48))
\end{lstlisting}

Feilen oppsto da fremmednøkkel feltet ble satt til null. Dette løste ved å sette riktig verdien til feltet eller sette fremmednøkkelen til nullable. 

\subsubsection{Data truncated for column}
Vi bruker UUID i stedet increments og trenger å identifisere primærnøkkelen slik.
\begin{lstlisting}
    $table->uuid(‘id’)->primary();
\end{lstlisting}

For å bruke UUID er det viktig å opprette UsesUuid.php trait i App / Trait.
Denne filen brukes til å opprette UUID automatisk når du oppretter nye modeller, deaktivere automatisk increments id-er, sette primærnøkkel som uuid og sette primærnøkkeltype som streng.\footnote{
\url{https://medium.com/@mamreezaa/use-uuid-in-lumen-d47ec02c330}}
Siden det ikke opprettet UsesUuid.php trait i App/Trait dukket opp feilmelding. 

\begin{lstlisting}
SQLSTATE[HY000]: General error: 1364 Field 'id' doesn't have a default value (SQL: insert into `fields` (`name`, `slug`, `updated_at`, `created_at`) values (HELLO WORLD, hello_world, 2019-02-06 08:57:48, 2019-02-06 08:57:48))
\end{lstlisting}
Dette betyr at det prøvde å sende UUID verdi i integer.
Dette ble løst med å lage en trait som automatisk lager en UUID når man lagrer modell til DB. (Filsti: /App/Traits/UsesUUID.php).\footnote{\url{ https://dev.to/wilburpowery/easily-use-uuids-in-laravel-45be.}}
 
\subsubsection{Fremmednøkkel feil}
Feilmeldingen oppsto da det ble prøvd å lagre en bruker på databasen. 

\begin{lstlisting}
    SQLSTATE[23000]: Integrity constraint violation: 1452 Cannot add or update a child row: a foreign key constraint fails (`sirkus-media`.`users`, CONSTRAINT `users_image_id_foreign` FOREIGN KEY (`image_id`) REFERENCES `images` (`id`)) (SQL: insert into `users` (`name`, `phone`, `email`, `password`, `image_id`, `verified`, `email_token`, `id`, `updated_at`, `created_at`) values (Bere, 4578891, berg@gmail.com, 1234567r, 2432479, 1, e-token, 53f98032-f9bf-40a6-9d70-ca9c0785d7ee, 2019-02-08 10:11:16, 2019-02-08 10:11:16))
\end{lstlisting}

Grunnen var at det ikke går an å sette verdi på en fremmednøkkel felt som verdien ikke finnes på referanse tabellen. Løste ved å sette riktig verdi.

\subsubsection{Fremmednøkkel er ikke satt riktig}
Feilmelding oppsto da migrasjonen utføres. 
Årsaken var at primær og fremmed nøklene satt på ulike type.
Dette betyr at primær nøkkelen blir satt på auto increments og den er unsignedInteger. Da det blir brukt som fremmed nøkkel på en annen tabell burde ha samme type. Dette var satt på integer.
Løste ved å endre typen integer til unsigned integer til fremmednøkkelen. Slik:

\begin{lstlisting}
    $table->integer('image_size_id')->unsigned();
    $table->foreign('image_size_id')->references('image_size_id')->on('image_sizes');
\end{lstlisting}

\subsubsection{Feilmelding om oppdatering og oppretting kolloner}
\begin{lstlisting}
    "SQLSTATE[42S22]: Column not found: 1054 Unknown column 'updated_at' in 'field list' (SQL: insert into `image_sizes` (`name`, `max_width`, `max_height`, `id`, `updated_at`, `created_at`) values (size-name, 10, 20, 879d1360-9a74-46f8-b383-ff6ec6e0f387, 2019-02-07 21:08:09, 2019-02-07 21:08:09))
\end{lstlisting}
Grunnen var at timestamps som oppretter opprettings- og oppdateringstiden er automatisk aktivert.
Løste ved å deaktivere den. Slik: 

\begin{lstlisting}
    public $timestamps = false;
\end{lstlisting}

\subsubsection{Auto Increments feil}
Feilmeldingen sa at fremmednøkkel var ikke satt riktig.
Dette var at auto increments er unsigned integer og brukte bare integer da jeg satte den som fremmednøkkel.
Løste ved å endre integer til UnsignedInteger ved fremmednøkkelen. Slik:

\begin{lstlisting}
    $table->integer(‘image_size_id’)->unsigned();
    $table->foreign(‘image_size_id’)->references(‘image_size_id’)->on(‘image_sizes’);
\end{lstlisting}

\subsubsection{Forelder/barn fremmednøkkel feil}
Fremmednøkkelen var satt på samme måte som i andre tabeller i et barn tabell. Problemet var at jeg prøvde å lage fremmednøkkel til en tabell som ikke er opprettet enda.
Måtte bryte dette inn i to Schema-blokker, en skaper kolonnene, den andre legger til fremmednøkkel.\footnote{\url{https://stackoverflow.com/questions/18427391/laravel-migration-self-referencing-foreign-key-issue}}
Løste ved å sette fremmednøkkelen på riktig måte. Slik
\begin{lstlisting}
Schema::create('components', function (Blueprint $table)
       {
           $table->uuid('id')->primary();
           $table->string('name');
           $table->string('slug');
           $table->integer('order');
           $table->uuid('parent_id')->nullable();
           $table->timestamps();
       });
       Schema::table('components', function(Blueprint $table){
           $table->foreign('parent_id')->references('id')->on('components');
       });
\end{lstlisting}

\subsection{Modelkobling test}
Flere fremmednøkkel-felter var satt til nullable som ikke skulle nullable. Startet med å fikse de feltene som skulle ikke ha nullable fremmednøkler.

\subsubsection{Ukjent kolonne feilmelding}
Siden forholdene mellom modellene var ikke satt riktig, oppsto feil under testingen.
\begin{lstlisting}
"SQLSTATE[42S22]: Column not found: 1054 Unknown column 'links.menu_link_id' in 'where clause' (SQL: select * from links where links.`menu_link_id` = 3 and links.`menu_link_id` is not null) 
\end{lstlisting}
Løste ved å gå gjennom alle modellene og fikse forholdene mellom dem.

\subsection {Roller og Permisjoner} \footnote{\url{https://github.com/spatie/laravel-permission#laravel}}

Laravel permisjon er en pakke med tillatelser og roller. Dette hjelper brukere til å knytte seg til tillatelser og roller. Hver rolle er knyttet til flere tillatelser. En rolle og en tillatelse er vanlige Eloquent-modeller\footnote{\url{https://scotch.io/tutorials/user-authorization-in-laravel-54-with-spatie-laravel-permission}}.
\subsubsection{Laravel permisjon pakke installasjon} 
Laravel permisjon pakken er bygget ut over laravel autorisasjon funksjoner\footnote{\url{https://laravel-news.com/two-best-roles-permissions-packages}}.
For installere permisjon pakken kjørte jeg composer require spatie/laravel-permission i kommando linje.

\subsubsection{Inkludere pakken på service provider listen}
Inkluderte permisjon pakken på config/app.php. 
\begin{lstlisting}
    Spatie\Permission\PermissionServiceProvider::class
\end{lstlisting}

\subsubsection{Publisere migrasjonen}
Ved å kjøre koden på kommandolinjen publisere migrasjon filen for permisjon pakken.
\begin{lstlisting}
   php artisan vendor:publish --provider="Spatie\Permission\PermissionServiceProvider" --tag="migrations" 
\end{lstlisting}

Siden vi bruker uuid som primær nøkkel på user måtte det redigeres permisjon filen. På permisjon filen er satt 'unsignedBigInteger' som standard og burde det  endres  til uuid. Redigeringen gjøres ved å åpne permisjon filen  under 'database/migrations' og erstatte 'unsignedBigInteger' med 'uuid'.
\begin{lstlisting}
  $table->unsignedBigInteger($columnNames['model_morph_key'])
    Erstatter med 
 $table->uuid($columnNames['model_morph_key'])
\end{lstlisting}

\subsubsection{Publisere konfigurasjonen}
Konfigureringsfilen tillater oss å angi plasseringen av Eloquent-modellen til permisjon og rolle klasse.
For å publisere konfigurasjonsfilen for pakken kjøres koden nede i kommandolinjen.

\begin{lstlisting}
  php artisan vendor:publish --provider="Spatie\Permission\PermissionServiceProvider" --tag="config"
\end{lstlisting}

\subsubsection{Bygge opp tabeller}
Tok migrasjon slik permisjon tabellene blir bygget på databasen.
Kjørte koden i kommandolinjen.
\begin{lstlisting}
  php artisan migrate
\end{lstlisting}

\subsection{Lage API}
For å lage api opprettet det først controller via cmd terminalen.
Gjøres slik:
\begin{lstlisting}
    php artisan make:controller PageController --resource
\end{lstlisting}
Den siste parameteren "resource" er et alternativ og kan dropes.
\url{https://laravel.com/docs/5.7/controllers}

På api.php fil under routes gjøres slik
\begin{lstlisting}
    Route::get('/pages', 'PageController@index');
\end{lstlisting} 
For en enkel page
\begin{lstlisting}
    Route::get('pages/{page}', 'PageController@show');
\end{lstlisting}
\url{https://laravel.com/docs/5.7/routing}




\clearpage